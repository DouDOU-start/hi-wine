{"version":3,"file":"index.js","sources":["pages/order/index.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvb3JkZXIvaW5kZXgudnVl"],"sourcesContent":["<template>\r\n  <view class=\"order-container\">\r\n    <view class=\"order-header\">我的订单</view>\r\n    \r\n    <!-- 订单状态选项卡 -->\r\n    <view class=\"order-tabs\">\r\n      <view \r\n        v-for=\"(tab, index) in statusTabs\" \r\n        :key=\"index\" \r\n        :class=\"['order-tab', activeTab === index ? 'active' : '']\"\r\n        @tap=\"changeTab(index)\"\r\n      >\r\n        {{ tab.name }}\r\n      </view>\r\n    </view>\r\n    \r\n    <view v-if=\"loading\" class=\"order-loading\">加载中...</view>\r\n    <view v-else-if=\"orders.length === 0\" class=\"order-empty\">暂无订单~</view>\r\n    <view v-else class=\"order-list\">\r\n      <view v-for=\"order in orders\" :key=\"order.id\" class=\"order-item\">\r\n        <view class=\"order-info\">\r\n          <text class=\"order-time\">{{ formatTime(order.createTime) }}</text>\r\n          <text :class=\"['order-status', 'status-' + order.status]\">{{ getStatusText(order.status) }}</text>\r\n        </view>\r\n        <view class=\"order-goods\">\r\n          <view v-for=\"item in orderItems[order.id]\" :key=\"item.id\" class=\"order-good\">\r\n            <image :src=\"item.productImage || IMG_BASE_URL + '/wine.png'\" class=\"order-img\" mode=\"aspectFill\" />\r\n            <view class=\"order-good-info\">\r\n              <text class=\"order-good-name\">{{ item.productName }}</text>\r\n              <text class=\"order-good-count\">x{{ item.quantity }}</text>\r\n            </view>\r\n          </view>\r\n        </view>\r\n        <view class=\"order-total\">合计：￥{{ order.totalAmount }}</view>\r\n        \r\n        <!-- 订单操作按钮 -->\r\n        <view class=\"order-actions\" v-if=\"order.status === 0\">\r\n          <button class=\"order-btn pay-btn\" @tap=\"payOrder(order)\">立即支付</button>\r\n          <button class=\"order-btn cancel-btn\" @tap=\"cancelOrder(order)\">取消订单</button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <!-- 上拉加载更多提示 -->\r\n    <view v-if=\"orders.length > 0 && !hasMore\" class=\"order-no-more\">没有更多订单了</view>\r\n    \r\n    <!-- 确认弹窗 -->\r\n    <uni-popup ref=\"confirmPopup\" type=\"dialog\">\r\n      <uni-popup-dialog\r\n        :title=\"popupConfig.title\"\r\n        :content=\"popupConfig.content\"\r\n        :before-close=\"true\"\r\n        @confirm=\"popupConfig.onConfirm\"\r\n        @close=\"closePopup\"\r\n      ></uni-popup-dialog>\r\n    </uni-popup>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { IMG_BASE_URL } from '@/config.js';\r\nimport api from '@/utils/api.js';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      orders: [],\r\n      orderItems: {}, // 订单商品映射表，key为订单ID\r\n      loading: false,\r\n      page: 1,\r\n      size: 10,\r\n      hasMore: true,\r\n      IMG_BASE_URL,\r\n      activeTab: 0,\r\n      statusTabs: [\r\n        { name: '全部', value: -1 },\r\n        { name: '待支付', value: 0 },\r\n        { name: '已支付', value: 1 },\r\n        { name: '已完成', value: 2 },\r\n        { name: '已取消', value: 3 }\r\n      ],\r\n      popupConfig: {\r\n        title: '',\r\n        content: '',\r\n        onConfirm: null\r\n      }\r\n    };\r\n  },\r\n  onLoad() {\r\n    this.loadOrders();\r\n  },\r\n  onShow() {\r\n    // 每次显示页面时刷新数据\r\n    this.refreshOrders();\r\n  },\r\n  methods: {\r\n    // 切换状态选项卡\r\n    changeTab(index) {\r\n      if (this.activeTab === index) return;\r\n      this.activeTab = index;\r\n      this.refreshOrders();\r\n    },\r\n    \r\n    // 刷新订单列表\r\n    refreshOrders() {\r\n      this.orders = [];\r\n      this.orderItems = {};\r\n      this.page = 1;\r\n      this.hasMore = true;\r\n      this.loadOrders();\r\n    },\r\n    \r\n    // 加载订单列表\r\n    async loadOrders() {\r\n      if (this.loading || !this.hasMore) return;\r\n      \r\n      this.loading = true;\r\n      try {\r\n        // 获取当前选中的状态值\r\n        const status = this.statusTabs[this.activeTab].value;\r\n        \r\n        const res = await api.getOrderList(status, this.page, this.size);\r\n        console.log('订单列表响应:', JSON.stringify(res));\r\n        \r\n        if (res && res.code === 0 && res.data && res.data.list) {\r\n          if (this.page === 1) {\r\n            this.orders = res.data.list;\r\n          } else {\r\n            this.orders = [...this.orders, ...res.data.list];\r\n          }\r\n          \r\n          // 判断是否还有更多数据\r\n          this.hasMore = res.data.list.length === this.size;\r\n          this.page++;\r\n          \r\n          // 加载每个订单的商品详情\r\n          for (const order of res.data.list) {\r\n            this.loadOrderItems(order.id);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('加载订单失败', err);\r\n        uni.showToast({\r\n          title: '加载订单失败',\r\n          icon: 'none'\r\n        });\r\n      } finally {\r\n        this.loading = false;\r\n      }\r\n    },\r\n    \r\n    // 加载订单商品\r\n    async loadOrderItems(orderId) {\r\n      try {\r\n        const res = await api.getOrderDetail(orderId);\r\n        console.log('订单详情响应:', JSON.stringify(res));\r\n        if (res && res.code === 0 && res.data && res.data.orderItems) {\r\n          // 使用Vue.set确保响应式更新\r\n          this.$set(this.orderItems, orderId, res.data.orderItems);\r\n        }\r\n      } catch (err) {\r\n        console.error(`加载订单${orderId}商品失败`, err);\r\n      }\r\n    },\r\n    \r\n    // 支付订单\r\n    payOrder(order) {\r\n      this.popupConfig = {\r\n        title: '支付订单',\r\n        content: `确认支付订单金额 ￥${order.totalAmount}？`,\r\n        onConfirm: async () => {\r\n          try {\r\n            // 调用更新订单状态API，将状态改为已支付(1)\r\n            const res = await api.updateOrderStatus(order.id, 1);\r\n            if (res && res.code === 0) {\r\n              uni.showToast({\r\n                title: '支付成功',\r\n                icon: 'success'\r\n              });\r\n              // 刷新订单列表\r\n              this.refreshOrders();\r\n            } else {\r\n              throw new Error('支付失败');\r\n            }\r\n          } catch (err) {\r\n            console.error('支付失败', err);\r\n            uni.showToast({\r\n              title: '支付失败',\r\n              icon: 'none'\r\n            });\r\n          }\r\n        }\r\n      };\r\n      this.$refs.confirmPopup.open();\r\n    },\r\n    \r\n    // 取消订单\r\n    cancelOrder(order) {\r\n      this.popupConfig = {\r\n        title: '取消订单',\r\n        content: '确认取消该订单？',\r\n        onConfirm: async () => {\r\n          try {\r\n            // 调用更新订单状态API，将状态改为已取消(3)\r\n            const res = await api.updateOrderStatus(order.id, 3);\r\n            if (res && res.code === 0) {\r\n              uni.showToast({\r\n                title: '订单已取消',\r\n                icon: 'success'\r\n              });\r\n              // 刷新订单列表\r\n              this.refreshOrders();\r\n            } else {\r\n              throw new Error('取消订单失败');\r\n            }\r\n          } catch (err) {\r\n            console.error('取消订单失败', err);\r\n            uni.showToast({\r\n              title: '取消订单失败',\r\n              icon: 'none'\r\n            });\r\n          }\r\n        }\r\n      };\r\n      this.$refs.confirmPopup.open();\r\n    },\r\n    \r\n    // 关闭弹窗\r\n    closePopup() {\r\n      this.$refs.confirmPopup.close();\r\n    },\r\n    \r\n    // 格式化时间\r\n    formatTime(time) {\r\n      if (!time) return '';\r\n      // 简单处理，实际项目中可以使用日期格式化库\r\n      return time.replace('T', ' ').split('.')[0];\r\n    },\r\n    \r\n    // 获取状态文本\r\n    getStatusText(status) {\r\n      switch (status) {\r\n        case 0: return '待支付';\r\n        case 1: return '已支付';\r\n        case 2: return '已完成';\r\n        case 3: return '已取消';\r\n        default: return '未知状态';\r\n      }\r\n    }\r\n  },\r\n  // 下拉刷新\r\n  onPullDownRefresh() {\r\n    this.refreshOrders();\r\n    uni.stopPullDownRefresh();\r\n  },\r\n  // 上拉加载更多\r\n  onReachBottom() {\r\n    this.loadOrders();\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.order-container {\r\n  min-height: 100vh;\r\n  background: #f8f6f4;\r\n  padding-bottom: 40rpx;\r\n}\r\n.order-header {\r\n  padding: 60rpx 0 20rpx 0;\r\n  text-align: center;\r\n  font-size: 48rpx;\r\n  font-weight: bold;\r\n  color: #222;\r\n  letter-spacing: 2rpx;\r\n}\r\n.order-tabs {\r\n  display: flex;\r\n  justify-content: space-around;\r\n  padding: 0 20rpx;\r\n  margin-bottom: 30rpx;\r\n}\r\n.order-tab {\r\n  font-size: 28rpx;\r\n  color: #666;\r\n  padding: 10rpx 20rpx;\r\n  position: relative;\r\n}\r\n.order-tab.active {\r\n  color: #f7cac9;\r\n  font-weight: bold;\r\n}\r\n.order-tab.active::after {\r\n  content: '';\r\n  position: absolute;\r\n  bottom: -6rpx;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  width: 40rpx;\r\n  height: 6rpx;\r\n  background: linear-gradient(90deg, #f7cac9 0%, #92a8d1 100%);\r\n  border-radius: 3rpx;\r\n}\r\n.order-loading, .order-empty, .order-no-more {\r\n  text-align: center;\r\n  color: #b8b8b8;\r\n  margin: 40rpx 0;\r\n  font-size: 28rpx;\r\n}\r\n.order-list {\r\n  padding: 0 24rpx;\r\n}\r\n.order-item {\r\n  background: #fff;\r\n  border-radius: 32rpx;\r\n  box-shadow: 0 4rpx 24rpx #eaeaea;\r\n  margin-bottom: 32rpx;\r\n  padding: 24rpx;\r\n}\r\n.order-info {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  margin-bottom: 16rpx;\r\n}\r\n.order-time {\r\n  color: #b8b8b8;\r\n  font-size: 28rpx;\r\n}\r\n.order-status {\r\n  font-size: 28rpx;\r\n  font-weight: bold;\r\n}\r\n.status-0 {\r\n  color: #f7cac9;\r\n}\r\n.status-1 {\r\n  color: #92a8d1;\r\n}\r\n.status-2 {\r\n  color: #67c23a;\r\n}\r\n.status-3 {\r\n  color: #909399;\r\n}\r\n.order-goods {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  gap: 16rpx;\r\n  margin-bottom: 12rpx;\r\n}\r\n.order-good {\r\n  display: flex;\r\n  align-items: center;\r\n  background: #f8f6f4;\r\n  border-radius: 16rpx;\r\n  padding: 8rpx 16rpx;\r\n  margin-right: 12rpx;\r\n}\r\n.order-img {\r\n  width: 60rpx;\r\n  height: 60rpx;\r\n  border-radius: 12rpx;\r\n  object-fit: cover;\r\n  margin-right: 12rpx;\r\n}\r\n.order-good-info {\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n.order-good-name {\r\n  font-size: 28rpx;\r\n  color: #222;\r\n}\r\n.order-good-count {\r\n  font-size: 24rpx;\r\n  color: #b8b8b8;\r\n}\r\n.order-total {\r\n  text-align: right;\r\n  color: #f7cac9;\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  margin-top: 8rpx;\r\n}\r\n.order-actions {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  margin-top: 20rpx;\r\n  gap: 20rpx;\r\n}\r\n.order-btn {\r\n  font-size: 24rpx;\r\n  border-radius: 24rpx;\r\n  padding: 6rpx 24rpx;\r\n}\r\n.pay-btn {\r\n  background: linear-gradient(90deg, #f7cac9 0%, #92a8d1 100%);\r\n  color: #fff;\r\n  border: none;\r\n}\r\n.cancel-btn {\r\n  background: #f5f5f5;\r\n  color: #909399;\r\n  border: none;\r\n}\r\n</style> ","import MiniProgramPage from 'D:/code/WeChatProjects/hi-wine/pages/order/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["IMG_BASE_URL","api","uni"],"mappings":"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"}